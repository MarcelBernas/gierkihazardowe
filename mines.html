<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="assets/img/icon.png" type="image/png">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="darkmodemines.css">
    <script src="darkmode.js" type="text/javascript"></script>
    <script src="pliki-cookies.js"></script>
    <title>Gra Mines</title>
</head>

<body onload="updateUserInfo()">
    <header>
        <div id="kolor-header-menu" onclick="redirectToHome()">
            <img src="assets/img/casino.png" alt="Logo" id="logo">
            <h1>Gierki hazardowe</h1>
        </div>

        <div id="token-display" onclick="resetTokens()">
            ≈ªetony: <span id="token_count">≈Åadowanie...</span>
        </div>

        <div id="userinfo">
            <img id="user-icon" src="assets/img/user.png" alt="User Icon" style="height: 2.5em; width: auto; margin-right: 0.5em; border-radius: 50%; width: 50px; height: 50px;">
                style="height: 2.5em; width: auto; margin-right: 0.5em;">
            <span id="user-name"
                onclick="editUserName()">nazwa u≈ºytkownika</span>
            <textarea id="edit-name"
                style="display: none; font-size: 1.5em; padding: 0.2em; border: 1px solid #ccc; border-radius: 4px; resize: none;"></textarea>
        </div>

        </div>
        <div id="darkmode-toggle" onclick="toggleDarkMode()" title="Prze≈ÇƒÖcz tryb">üåô</div>
    </header>
    <div class="gra-container">
        <h1>Gra Mines</h1>

        <div class="sterowanie">
            <div>
                <label for="rozmiarPlanszy">Rozmiar planszy:</label>
                <input type="number" id="rozmiarPlanszy" value="4">
            </div>
            <div>
                <label for="liczbaBomb">Liczba bomb:</label>
                <input type="number" id="liczbaBomb" value="3">
            </div>
            <div>
                <label for="stawka">Stawka:</label>
                <input type="number" id="stawka" value="100" step="100">
            </div>
            <button id="rozpocznijBtn">Rozpocznij grƒô</button>
            <button id="wyp≈ÇataBtn">Wyp≈Çaƒá</button>
        </div>

        <div id="plansza" class="plansza"></div>
        <div id="wynik" class="wynik">Wp≈Çacono: 0</div>
        <div id="aktualnaStawka" class="wynik">Stawka: 0</div>

        <img style="z-index:99; width: 150px;" src="assets/img/bomb.png" alt="Bomb" class="bomb-image">
        
    </div>
    <footer>
        <p>Strona stworzona przez Miko≈Çaja Grabowskiego, Marcela Bernasia i ≈Åukasza Dolnego.</p>
    </footer>
    <script>
        const plansza = document.getElementById('plansza');
        const wynik = document.getElementById('wynik');
        const rozpocznijBtn = document.getElementById('rozpocznijBtn');
        const wyp≈ÇataBtn = document.getElementById('wyp≈ÇataBtn');
        const stawkaInput = document.getElementById('stawka');
        const liczbaBombInput = document.getElementById('liczbaBomb');
        const rozmiarPlanszyInput = document.getElementById('rozmiarPlanszy');
        const aktualnaStawka = document.getElementById('aktualnaStawka');

        let rozmiarPlanszy = 4;
        let liczbaBomb = 3;
        let graAktywna = false;
        let danePlanszy = [];
        let ujawnionePola = 0;
        let stawka = 1;
        let trafionePola = 0;
        let wszystkiePola;
        let pozostalePola;

        function sprawdzWarunki(stawka, wplacono, rozmiarPlanszy, liczbaBomb){
            if (stawka < 1) {
                alert("Stawka nie mo≈ºe byƒá mniejsza od 1, biedaku.");
                return true;
            }
            if (wplacono > (parseInt(document.cookie.split("; ").find((row) => row.startsWith("chips="))?.split("=")[1]))) {            //refactor this
                alert("Masz za ma≈Ço ≈ºeton√≥w.");
                return true;
            }
            if (rozmiarPlanszy < 2){
                alert("Rozmiar planszy nie mo≈ºe byƒá mniejszy od 2.");
                return true;
            }

            if (liczbaBomb >= rozmiarPlanszy * rozmiarPlanszy) {
                alert("Liczba bomb nie mo≈ºe byƒá wiƒôksza lub r√≥wna liczbie p√≥l!");
                return true;
            }

            if (liczbaBomb < 1) {
                alert("Liczba bomb nie mo≈ºe byƒá mniejsza ni≈º 1!");
                return true;
            }

            return false;
        }

        function rozpocznijGrƒô() {
            rozmiarPlanszy = parseInt(rozmiarPlanszyInput.value);
            liczbaBomb = parseInt(liczbaBombInput.value);
            stawka = parseFloat(stawkaInput.value);
            const wplacono = parseFloat(stawkaInput.value);
            
            if (sprawdzWarunki(stawka, wplacono, rozmiarPlanszy, liczbaBomb)) {
                return;
            }

            rozmiarPlanszyInput.disabled = true;
            liczbaBombInput.disabled = true;
            stawkaInput.disabled = true;
            rozpocznijBtn.disabled = true;

            graAktywna = true;
            danePlanszy = [];
            ujawnionePola = 0;
            trafionePola = 0;
            wynik.textContent = `Wp≈Çacono: ${stawka}`;
            aktualnaStawka.textContent = `Stawka: ${stawka}`;
            plansza.innerHTML = '';

            plansza.style.gridTemplateColumns = `repeat(${rozmiarPlanszy}, 60px)`;

            wszystkiePola = rozmiarPlanszy * rozmiarPlanszy;
            pozostalePola = wszystkiePola - liczbaBomb;

            for (let i = 0; i < wszystkiePola; i++) {
                const komorka = document.createElement('div');
                komorka.classList.add('komorka-planszy');
                komorka.dataset.index = i;
                komorka.addEventListener('click', kliknijKomorke);
                plansza.appendChild(komorka);
                danePlanszy.push({
                    ujawnione: false,
                    jestBomba: false,
                });
            }

            let bombyUstawione = 0;
            while (bombyUstawione < liczbaBomb) {
                let losowyIndex = Math.floor(Math.random() * wszystkiePola);
                if (!danePlanszy[losowyIndex].jestBomba) {
                    danePlanszy[losowyIndex].jestBomba = true;
                    bombyUstawione++;
                }
            }

            function kliknijKomorke(event) {
                if (!graAktywna) return;

                const index = event.target.dataset.index;
                const komorka = event.target;

                if (danePlanszy[index].ujawnione) return;

                danePlanszy[index].ujawnione = true;
                ujawnionePola++;
                komorka.classList.add('ujawniona');

                if (danePlanszy[index].jestBomba) {
                    komorka.classList.add('bomba');
                    wynik.textContent = `Game Over! Straci≈Çe≈õ ${wplacono}!`;
                    graAktywna = false;
                    document.cookie = "chips=" + (parseInt(document.cookie.split("; ").find((row) => row.startsWith("chips="))?.split("=")[1]) - wplacono) + "; SameSite=None; secure; expires=Fri, 20 Aug 2077 12:00:00 UTC; path=/";
                    updateUserInfo();
                    ujawnijWszystkieKomorki();
                } else {
                    komorka.classList.add('pusta', 'flip-horizontal-bottom');
                    trafionePola++;
                    const mnoznik = 1 + ((trafionePola * 1.8) / pozostalePola);
                    stawka = Math.round(parseFloat(stawkaInput.value) * mnoznik);
                    aktualnaStawka.textContent = `Stawka: ${stawka} (Pomno≈ºona o ${mnoznik.toFixed(2)} razy)`;
                }

                if (ujawnionePola === pozostalePola) {
                    wynik.textContent = `Gratulacje! Wygra≈Çe≈õ ${stawka}!`;
                    graAktywna = false;
                    document.cookie = "chips=" + (parseInt(document.cookie.split("; ").find((row) => row.startsWith("chips="))?.split("=")[1]) + stawka - wplacono) + "; SameSite=None; secure; expires=Fri, 20 Aug 2077 12:00:00 UTC; path=/";
                    updateUserInfo();
                    ujawnijWszystkieKomorki();
                }
            }
        }

        function ujawnijWszystkieKomorki() {
            rozmiarPlanszyInput.disabled = false;
            liczbaBombInput.disabled = false;
            stawkaInput.disabled = false;
            rozpocznijBtn.disabled = false;
            danePlanszy.forEach((komorkaData, index) => {
                const komorka = plansza.children[index];
                if (!komorkaData.ujawnione) {
                    komorka.classList.add('ujawniona');
                    if (komorkaData.jestBomba) {
                        komorka.classList.add('bomba');
                    }
                }
            });
        }

        function wyplac() {
            const wplacono = parseFloat(stawkaInput.value);

            if (graAktywna) {
                graAktywna = false;
                wynik.textContent = `Wyp≈Çacono! Otrzyma≈Çe≈õ ${stawka} ≈ºeton√≥w.`;
                document.cookie = "chips=" + (parseInt(document.cookie.split("; ").find((row) => row.startsWith("chips="))?.split("=")[1]) + stawka - wplacono) + "; SameSite=None; secure; expires=Fri, 20 Aug 2077 12:00:00 UTC; path=/";
                updateUserInfo();
                ujawnijWszystkieKomorki();
            }
        }

        rozpocznijBtn.addEventListener('click', rozpocznijGrƒô);
        wyp≈ÇataBtn.addEventListener('click', wyplac);
    </script>
</body>

</html>